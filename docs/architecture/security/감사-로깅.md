# ğŸ“ ê°ì‚¬ ë¡œê¹…

## 100% ê°ì‚¬ ë¡œê¹…

**ë¡œê¹… ëŒ€ìƒ:**
- ëª¨ë“  API í˜¸ì¶œ
- ë°ì´í„° ìƒì„±/ìˆ˜ì •/ì‚­ì œ
- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
- ê¶Œí•œ ë³€ê²½
- ì •ì±… ìŠ¹ì¸/ë°°í¬
- ì‚¬ë¡€ ì¡°ì‚¬ í™œë™

## Audit Log êµ¬ì¡°

```java
@Data
@Builder
public class AuditLog {
    private String id;                    // ULID
    private String userId;                // ì‚¬ìš©ì ID
    private String username;              // ì‚¬ìš©ìëª…
    private String action;                // í–‰ìœ„ (CREATE, READ, UPDATE, DELETE, APPROVE, etc.)
    private String resource;              // ë¦¬ì†ŒìŠ¤ íƒ€ì… (USER, POLICY, CASE, etc.)
    private String resourceId;            // ë¦¬ì†ŒìŠ¤ ID
    private String beforeValue;           // ë³€ê²½ ì „ ê°’ (JSON)
    private String afterValue;            // ë³€ê²½ í›„ ê°’ (JSON)
    private String ipAddress;             // IP ì£¼ì†Œ
    private String userAgent;             // User Agent
    private LocalDateTime timestamp;      // íƒ€ì„ìŠ¤íƒ¬í”„
    private String result;                // ê²°ê³¼ (SUCCESS, FAILURE)
    private String errorMessage;          // ì—ëŸ¬ ë©”ì‹œì§€ (ì‹¤íŒ¨ ì‹œ)
}
```

## AOP ê¸°ë°˜ ìë™ ë¡œê¹…

```java
@Aspect
@Component
@Slf4j
@RequiredArgsConstructor
public class AuditLoggingAspect {
    
    private final AuditLogRepository auditLogRepository;
    
    @Around("@annotation(auditable)")
    public Object logAudit(ProceedingJoinPoint joinPoint, Auditable auditable) throws Throwable {
        // Before execution
        String userId = SecurityContextHolder.getContext().getAuthentication().getName();
        String action = auditable.action();
        String resource = auditable.resource();
        
        Object result = null;
        String status = "SUCCESS";
        String errorMessage = null;
        
        try {
            result = joinPoint.proceed();
        } catch (Exception e) {
            status = "FAILURE";
            errorMessage = e.getMessage();
            throw e;
        } finally {
            // After execution (success or failure)
            AuditLog auditLog = AuditLog.builder()
                .userId(userId)
                .action(action)
                .resource(resource)
                .timestamp(LocalDateTime.now())
                .result(status)
                .errorMessage(errorMessage)
                .build();
            
            auditLogRepository.insert(auditLog);
        }
        
        return result;
    }
}
```

**ì‚¬ìš© ì˜ˆì‹œ:**

```java
@Service
public class PolicyService {
    
    @Auditable(action = "CREATE", resource = "POLICY")
    public Policy createPolicy(CreatePolicyRequest request) {
        // Business logic
    }
    
    @Auditable(action = "APPROVE", resource = "POLICY")
    public void approvePolicy(String policyId) {
        // Business logic
    }
}
```

## ê°ì‚¬ ë¡œê·¸ ë³´ì¡´

**ë³´ì¡´ ê¸°ê°„:**
- ìµœì†Œ 7ë…„ (ê¸ˆìœµ ê·œì •)
- ë³„ë„ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
- ì½ê¸° ì „ìš© ë³µì œë³¸ ìƒì„±
- ì •ê¸°ì  ë°±ì—…

**ì•„ì¹´ì´ë¹™:**
```sql
-- 1ë…„ ì´ìƒ ëœ ë¡œê·¸ëŠ” ë³„ë„ í…Œì´ë¸”ë¡œ ì´ë™
INSERT INTO audit_log_archive
SELECT * FROM audit_log
WHERE timestamp < NOW() - INTERVAL '1 year';

DELETE FROM audit_log
WHERE timestamp < NOW() - INTERVAL '1 year';
```

---
