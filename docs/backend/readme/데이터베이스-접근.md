# ğŸ—„ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼

## MyBatis Mapper íŒ¨í„´

### 1. Mapper Interface

```java
package com.inspecthub.policy.mapper;

import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;
import java.util.Optional;

@Mapper
public interface PolicyMapper {
    
    // INSERT
    int insert(Policy policy);
    
    // SELECT (ë‹¨ê±´)
    Optional<Policy> findById(@Param("id") String id);
    
    // SELECT (ëª©ë¡)
    List<Policy> findAll(@Param("status") String status);
    
    // UPDATE
    int update(Policy policy);
    
    // DELETE (ë…¼ë¦¬ì  ì‚­ì œ)
    int softDelete(@Param("id") String id, @Param("deletedBy") String deletedBy);
    
    // Custom queries
    List<Policy> findActiveByType(@Param("type") String type);
    int countByStatus(@Param("status") String status);
}
```

### 2. Mapper XML

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.inspecthub.policy.mapper.PolicyMapper">

    <!-- ResultMap -->
    <resultMap id="PolicyResultMap" type="com.inspecthub.policy.entity.Policy">
        <id property="id" column="id"/>
        <result property="type" column="type"/>
        <result property="version" column="version"/>
        <result property="status" column="status"/>
        <result property="effectiveFrom" column="effective_from"/>
        <result property="effectiveTo" column="effective_to"/>
        <result property="configJson" column="config_json" 
                typeHandler="org.apache.ibatis.type.JsonTypeHandler"/>
        <result property="createdAt" column="created_at"/>
        <result property="createdBy" column="created_by"/>
    </resultMap>

    <!-- INSERT -->
    <insert id="insert">
        INSERT INTO standard_snapshot (
            id, type, version, status,
            effective_from, effective_to, config_json,
            created_at, created_by
        ) VALUES (
            #{id}, #{type}, #{version}, #{status},
            #{effectiveFrom}, #{effectiveTo}, #{configJson}::jsonb,
            #{createdAt}, #{createdBy}
        )
    </insert>

    <!-- SELECT by ID -->
    <select id="findById" resultMap="PolicyResultMap">
        SELECT *
        FROM standard_snapshot
        WHERE id = #{id}
          AND deleted = FALSE
    </select>

    <!-- SELECT with dynamic WHERE -->
    <select id="findAll" resultMap="PolicyResultMap">
        SELECT *
        FROM standard_snapshot
        WHERE deleted = FALSE
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- UPDATE -->
    <update id="update">
        UPDATE standard_snapshot
        SET status = #{status},
            effective_to = #{effectiveTo},
            updated_at = #{updatedAt},
            updated_by = #{updatedBy}
        WHERE id = #{id}
          AND deleted = FALSE
    </update>

    <!-- Soft DELETE -->
    <update id="softDelete">
        UPDATE standard_snapshot
        SET deleted = TRUE,
            deleted_at = NOW(),
            deleted_by = #{deletedBy}
        WHERE id = #{id}
          AND deleted = FALSE
    </update>

    <!-- Custom query with JOIN -->
    <select id="findActiveByType" resultMap="PolicyResultMap">
        SELECT s.*
        FROM standard_snapshot s
        WHERE s.type = #{type}
          AND s.status = 'ACTIVE'
          AND s.deleted = FALSE
          AND s.effective_from &lt;= NOW()
          AND (s.effective_to IS NULL OR s.effective_to &gt; NOW())
        ORDER BY s.version DESC
    </select>

</mapper>
```

### 3. Service Layer Usage

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class PolicyService {
    
    private final PolicyMapper policyMapper;
    
    @Transactional
    public Policy createPolicy(CreatePolicyRequest request) {
        Policy policy = Policy.builder()
            .type(request.getType())
            .version(request.getVersion())
            .status("DRAFT")
            .effectiveFrom(request.getEffectiveFrom())
            .configJson(request.getConfigJson())
            .build();
        
        // Set ULID and timestamps
        policy.prePersist(getCurrentUserId());
        
        // Insert
        policyMapper.insert(policy);
        
        log.info("Policy created: id={}", policy.getId());
        return policy;
    }
    
    public Policy getPolicy(String id) {
        return policyMapper.findById(id)
            .orElseThrow(() -> new PolicyNotFoundException(
                "Policy not found: " + id
            ));
    }
    
    @Transactional
    public void deletePolicy(String id) {
        Policy policy = getPolicy(id);
        policyMapper.softDelete(id, getCurrentUserId());
        log.info("Policy soft deleted: id={}", id);
    }
}
```

## ULID ì‚¬ìš©

ëª¨ë“  Primary KeyëŠ” **ULID (26ì)**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```java
// BaseDomainì„ ìƒì†ë°›ìœ¼ë©´ ìë™ ì§€ì›
@Data
@SuperBuilder
@NoArgsConstructor
@EqualsAndHashCode(callSuper = true)
public class Policy extends BaseDomain {
    private String type;
    private Integer version;
    // ...
}

// Entity ìƒì„± ì‹œ
Policy policy = Policy.builder()
    .type("STR")
    .version(1)
    .build();

policy.prePersist(currentUserId); // ULID ìë™ ìƒì„±
System.out.println(policy.getId()); // "01ARZ3NDEKTSV4RRFFQ69G5FAV"
```

**ìƒì„¸ ê°€ì´ë“œ:** [ULID.md](./ULID.md)

---
