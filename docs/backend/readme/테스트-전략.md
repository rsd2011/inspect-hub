# ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

## í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ

```
        â•±â•²
       â•±E2Eâ•²         10% - í†µí•© í…ŒìŠ¤íŠ¸ (ëŠë¦¼)
      â•±â”â”â”â”â”â”â•²
     â•± Integrationâ•²   20% - í†µí•© í…ŒìŠ¤íŠ¸ (ì¤‘ê°„)
    â•±â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•²
   â•±   Unit Tests   â•² 70% - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë¹ ë¦„)
  â•±â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•²
```

## 1. Unit Tests (ë‹¨ìœ„ í…ŒìŠ¤íŠ¸)

**ëŒ€ìƒ:** Service ë ˆì´ì–´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

```java
@ExtendWith(MockitoExtension.class)
class PolicyServiceTest {
    
    @Mock
    private PolicyMapper policyMapper;
    
    @InjectMocks
    private PolicyService policyService;
    
    @Test
    @DisplayName("ì •ì±… ìƒì„± - ì„±ê³µ")
    void createPolicy_Success() {
        // Given
        CreatePolicyRequest request = CreatePolicyRequest.builder()
            .type("STR")
            .version(1)
            .effectiveFrom(LocalDateTime.now())
            .configJson(Map.of("threshold", 10000))
            .build();
        
        // When
        Policy result = policyService.createPolicy(request);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isNotNull(); // ULID ìƒì„± í™•ì¸
        assertThat(result.getType()).isEqualTo("STR");
        
        verify(policyMapper, times(1)).insert(any(Policy.class));
    }
    
    @Test
    @DisplayName("ì •ì±… ì¡°íšŒ - ì¡´ì¬í•˜ì§€ ì•ŠìŒ")
    void getPolicy_NotFound() {
        // Given
        String id = "01ARZ3NDEKTSV4RRFFQ69G5FAV";
        when(policyMapper.findById(id)).thenReturn(Optional.empty());
        
        // When & Then
        assertThatThrownBy(() -> policyService.getPolicy(id))
            .isInstanceOf(PolicyNotFoundException.class)
            .hasMessageContaining(id);
    }
}
```

## 2. Integration Tests (í†µí•© í…ŒìŠ¤íŠ¸)

**ëŒ€ìƒ:** Controller + Service + MyBatis + Database

```java
@SpringBootTest
@AutoConfigureMockMvc
@Sql(scripts = "/test-data.sql") // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™”
@Transactional // í…ŒìŠ¤íŠ¸ í›„ ë¡¤ë°±
class PolicyControllerIntegrationTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    @DisplayName("ì •ì±… ìƒì„± API - ì„±ê³µ")
    void createPolicy_Success() throws Exception {
        // Given
        CreatePolicyRequest request = CreatePolicyRequest.builder()
            .type("STR")
            .version(1)
            .effectiveFrom(LocalDateTime.now())
            .configJson(Map.of("threshold", 10000))
            .build();
        
        // When & Then
        mockMvc.perform(post("/api/v1/policies")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.success").value(true))
            .andExpect(jsonPath("$.data.id").exists())
            .andExpect(jsonPath("$.data.type").value("STR"))
            .andDo(print());
    }
    
    @Test
    @DisplayName("ì •ì±… ì¡°íšŒ API - ì¡´ì¬í•˜ì§€ ì•ŠìŒ")
    void getPolicy_NotFound() throws Exception {
        // When & Then
        mockMvc.perform(get("/api/v1/policies/INVALID_ID"))
            .andExpect(status().isNotFound())
            .andExpect(jsonPath("$.success").value(false))
            .andExpect(jsonPath("$.errorCode").value("POLICY_NOT_FOUND"))
            .andDo(print());
    }
}
```

## 3. Testcontainers (Database Tests)

```java
@SpringBootTest
@Testcontainers
class PolicyRepositoryTest {
    
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:14")
        .withDatabaseName("test")
        .withUsername("test")
        .withPassword("test");
    
    @DynamicPropertySource
    static void properties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername());
        registry.add("spring.datasource.password", postgres::getPassword);
    }
    
    @Autowired
    private PolicyMapper policyMapper;
    
    @Test
    @DisplayName("ì •ì±… ì €ì¥ ë° ì¡°íšŒ")
    void saveAndFind() {
        // Given
        Policy policy = Policy.builder()
            .type("STR")
            .version(1)
            .status("DRAFT")
            .build();
        policy.prePersist("TEST_USER");
        
        // When
        policyMapper.insert(policy);
        Policy found = policyMapper.findById(policy.getId()).orElse(null);
        
        // Then
        assertThat(found).isNotNull();
        assertThat(found.getId()).isEqualTo(policy.getId());
        assertThat(found.getType()).isEqualTo("STR");
    }
}
```

## í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸
./gradlew test

# íŠ¹ì • ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
./gradlew :policy:test

# íŠ¹ì • í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤
./gradlew test --tests PolicyServiceTest

# í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
./gradlew test jacocoTestReport
# ë¦¬í¬íŠ¸ ìœ„ì¹˜: build/reports/jacoco/test/html/index.html

# í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
./gradlew integrationTest

# ë¹ ë¥¸ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
./gradlew build -x test
```

---
