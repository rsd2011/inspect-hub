# 보안 테스트

## JWT Authentication Test

```java
package com.inspecthub.security;

import com.inspecthub.security.jwt.JwtTokenProvider;
import com.inspecthub.security.jwt.JwtTokenValidator;
import com.inspecthub.test.BaseUnitTest;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.springframework.security.core.Authentication;

import java.util.List;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.BDDMockito.*;

@DisplayName("JWT 인증 테스트")
class JwtAuthenticationTest extends BaseUnitTest {

    @Mock
    private JwtTokenValidator tokenValidator;
    
    @InjectMocks
    private JwtTokenProvider tokenProvider;
    
    private String userId;
    private String username;
    private List<String> roles;
    
    @BeforeEach
    void setUp() {
        userId = "01HGW2N7XKQJBZ9VFQR8X7Y3ZT";
        username = "testuser";
        roles = List.of("ROLE_USER");
    }
    
    @Test
    @DisplayName("액세스 토큰 생성")
    void generateAccessToken() {
        // When
        String token = tokenProvider.generateAccessToken(userId, username, roles);
        
        // Then
        assertThat(token).isNotNull();
        assertThat(token).startsWith("eyJ");  // JWT header
        assertThat(token.split("\\.")).hasSize(3);  // header.payload.signature
    }
    
    @Test
    @DisplayName("토큰 검증 - 유효한 토큰")
    void validateToken_Valid() {
        // Given
        String token = tokenProvider.generateAccessToken(userId, username, roles);
        given(tokenValidator.validateToken(token)).willReturn(true);
        
        // When
        boolean isValid = tokenValidator.validateToken(token);
        
        // Then
        assertThat(isValid).isTrue();
    }
    
    @Test
    @DisplayName("토큰 검증 - 만료된 토큰")
    void validateToken_Expired() {
        // Given
        String expiredToken = "eyJhbGciOiJIUzI1NiJ9.expired.token";
        given(tokenValidator.validateToken(expiredToken)).willReturn(false);
        
        // When
        boolean isValid = tokenValidator.validateToken(expiredToken);
        
        // Then
        assertThat(isValid).isFalse();
    }
    
    @Test
    @DisplayName("토큰에서 사용자 정보 추출")
    void extractUserInfo() {
        // Given
        String token = tokenProvider.generateAccessToken(userId, username, roles);
        
        // When
        String extractedUserId = tokenProvider.getUserId(token);
        String extractedUsername = tokenProvider.getUsername(token);
        List<String> extractedRoles = tokenProvider.getRoles(token);
        
        // Then
        assertThat(extractedUserId).isEqualTo(userId);
        assertThat(extractedUsername).isEqualTo(username);
        assertThat(extractedRoles).containsExactlyInAnyOrderElementsOf(roles);
    }
}
```

## Authorization Test

```java
package com.inspecthub.security;

import com.inspecthub.test.BaseIntegrationTest;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@AutoConfigureMockMvc
@DisplayName("권한 인가 테스트")
class AuthorizationTest extends BaseIntegrationTest {

    @Autowired
    private MockMvc mockMvc;
    
    @Test
    @WithMockUser(roles = "ADMIN")
    @DisplayName("ADMIN 권한 - 사용자 생성 가능")
    void adminCanCreateUser() throws Exception {
        mockMvc.perform(post("/api/v1/users")
                .contentType("application/json")
                .content("{}"))
            .andExpect(status().isOk());  // 400 Bad Request가 아닌 200 OK (권한은 통과)
    }
    
    @Test
    @WithMockUser(roles = "USER")
    @DisplayName("USER 권한 - 사용자 생성 불가 (403)")
    void userCannotCreateUser() throws Exception {
        mockMvc.perform(post("/api/v1/users")
                .contentType("application/json")
                .content("{}"))
            .andExpect(status().isForbidden());
    }
    
    @Test
    @WithMockUser(roles = "USER", username = "user1")
    @DisplayName("자신의 정보 조회 가능")
    void userCanViewOwnProfile() throws Exception {
        // Mock setup: user1's ID
        String userId = "01HGW2N7XKQJBZ9VFQR8X7Y3ZT";
        
        mockMvc.perform(get("/api/v1/users/{id}", userId))
            .andExpect(status().isOk());
    }
    
    @Test
    @WithMockUser(roles = "COMPLIANCE_OFFICER")
    @DisplayName("컴플라이언스 오피서 - 사례 승인 가능")
    void complianceOfficerCanApproveCases() throws Exception {
        String caseId = "01HGW2N7XKQJBZ9VFQR8X7Y3ZT";
        
        mockMvc.perform(post("/api/v1/cases/{id}/approve", caseId)
                .contentType("application/json")
                .content("{\"comment\": \"Approved\"}"))
            .andExpect(status().isOk());
    }
}
```

---
