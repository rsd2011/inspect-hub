# 데이터베이스 마이그레이션

## Flyway 설정

```groovy
// backend/build.gradle.kts
plugins {
    id("org.flywaydb.flyway") version "10.0.0"
}

flyway {
    url = System.getenv("DB_URL") ?: "jdbc:postgresql://localhost:5432/inspecthub_prod"
    user = System.getenv("DB_USERNAME") ?: "inspecthub_app"
    password = System.getenv("DB_PASSWORD") ?: ""
    schemas = arrayOf("public")
    locations = arrayOf("classpath:db/migration")
    baselineOnMigrate = true
    validateOnMigrate = true
}
```

## 마이그레이션 스크립트 예시

```sql
-- backend/src/main/resources/db/migration/V1__initial_schema.sql

-- User 테이블
CREATE TABLE "user" (
  id VARCHAR(26) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  full_name VARCHAR(100) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
  org_id VARCHAR(26),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  deleted BOOLEAN NOT NULL DEFAULT FALSE,
  deleted_at TIMESTAMP,
  deleted_by VARCHAR(26)
);

CREATE INDEX idx_user_username ON "user"(username);
CREATE INDEX idx_user_email ON "user"(email);
CREATE INDEX idx_user_org_id ON "user"(org_id);
CREATE INDEX idx_user_status ON "user"(status);

-- Organization 테이블
CREATE TABLE organization (
  id VARCHAR(26) PRIMARY KEY,
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  parent_id VARCHAR(26),
  org_type VARCHAR(50) NOT NULL,
  level INTEGER NOT NULL,
  path VARCHAR(500),
  org_policy_id VARCHAR(26),
  active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (parent_id) REFERENCES organization(id)
);

CREATE INDEX idx_org_code ON organization(code);
CREATE INDEX idx_org_parent_id ON organization(parent_id);
CREATE INDEX idx_org_path ON organization(path);

-- ... (더 많은 테이블)
```

```sql
-- V2__add_audit_log.sql
CREATE TABLE audit_log (
  id VARCHAR(26) PRIMARY KEY,
  user_id VARCHAR(26),
  username VARCHAR(50),
  action VARCHAR(100) NOT NULL,
  resource VARCHAR(100),
  resource_id VARCHAR(26),
  ip_address VARCHAR(45),
  user_agent TEXT,
  before_json JSONB,
  after_json JSONB,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at);

-- 월별 파티션 생성 (예시)
CREATE TABLE audit_log_2025_01 PARTITION OF audit_log
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE INDEX idx_audit_log_user_id ON audit_log(user_id);
CREATE INDEX idx_audit_log_action ON audit_log(action);
CREATE INDEX idx_audit_log_created_at ON audit_log(created_at);
```

## 마이그레이션 실행

```bash
# 로컬 개발
./gradlew flywayMigrate

# 프로덕션 (환경 변수 설정)
DB_URL=jdbc:postgresql://prod-db:5432/inspecthub_prod \
DB_USERNAME=inspecthub_app \
DB_PASSWORD=prod_password \
./gradlew flywayMigrate

# 마이그레이션 정보 확인
./gradlew flywayInfo

# 마이그레이션 검증
./gradlew flywayValidate

# 롤백 (상용 라이선스 필요)
./gradlew flywayUndo
```

## 배포 전 마이그레이션 체크리스트

- [ ] 마이그레이션 스크립트 테스트 완료 (dev/staging)
- [ ] 롤백 시나리오 검증
- [ ] 데이터베이스 백업 완료
- [ ] 다운타임 필요 여부 확인
- [ ] 대용량 테이블 변경 시 온라인 DDL 사용
- [ ] 인덱스 생성 시 CONCURRENTLY 옵션 사용
- [ ] 마이그레이션 실행 권한 확인

---
