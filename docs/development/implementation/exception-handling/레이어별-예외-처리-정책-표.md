# ğŸ“Š ë ˆì´ì–´ë³„ ì˜ˆì™¸ ì²˜ë¦¬ ì •ì±… í‘œ

> **í•µì‹¬ ì„¹ì…˜**: ê° ë ˆì´ì–´ì—ì„œ ì–´ë–¤ ì—ëŸ¬ë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ ëª…í™•íˆ ì •ì˜

## Controller ë ˆì´ì–´

| ì—ëŸ¬ ìœ í˜• | ì²˜ë¦¬ ë°©ì‹ | try/catch ì‚¬ìš© ì—¬ë¶€ | ì˜ˆì‹œ |
|-----------|-----------|---------------------|------|
| **ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸** | Serviceë¡œ ìœ„ì„ â†’ ì „ì—­ í•¸ë“¤ëŸ¬ë¡œ ì „íŒŒ | âŒ ì‚¬ìš© ê¸ˆì§€ | `UserNotFoundException`, `InvalidPasswordException` |
| **Validation ì‹¤íŒ¨** | `@Valid` ìë™ ì²˜ë¦¬ â†’ ì „ì—­ í•¸ë“¤ëŸ¬ | âŒ ì‚¬ìš© ê¸ˆì§€ | `MethodArgumentNotValidException` |
| **HTTP íŒŒì‹± ì˜¤ë¥˜** | ì „ì—­ í•¸ë“¤ëŸ¬ ì²˜ë¦¬ | âŒ ì‚¬ìš© ê¸ˆì§€ | `HttpMessageNotReadableException` |
| **ì¸ì¦/ì¸ê°€ ì‹¤íŒ¨** | Spring Security í•„í„° â†’ ì „ì—­ í•¸ë“¤ëŸ¬ | âŒ ì‚¬ìš© ê¸ˆì§€ | `AccessDeniedException` |

**ì›ì¹™:**
- âŒ Controllerì—ì„œ try-catchë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ë¥¼ ì§ì ‘ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
- âœ… ëª¨ë“  ì˜ˆì™¸ëŠ” ì „ì—­ í•¸ë“¤ëŸ¬(`GlobalExceptionHandler`)ë¡œ ì „íŒŒ
- âœ… HTTP ìƒíƒœ ì½”ë“œ ë§¤í•‘ì€ ì „ì—­ í•¸ë“¤ëŸ¬ê°€ ë‹´ë‹¹

**Good Example:**
```java
@PostMapping("/login")
public ResponseEntity<ApiResponse<TokenResponse>> login(@Valid @RequestBody LoginRequest request) {
    // âœ… Serviceì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ëŠ” ì „ì—­ í•¸ë“¤ëŸ¬ë¡œ ìë™ ì „íŒŒ
    TokenResponse token = authService.authenticate(request);
    return ResponseEntity.ok(ApiResponse.success(token));
}
```

**Bad Example:**
```java
@PostMapping("/login")
public ResponseEntity<ApiResponse<TokenResponse>> login(@Valid @RequestBody LoginRequest request) {
    try {
        TokenResponse token = authService.authenticate(request);
        return ResponseEntity.ok(ApiResponse.success(token));
    } catch (BusinessException e) {
        // âŒ Controllerì—ì„œ ì§ì ‘ ì˜ˆì™¸ ì²˜ë¦¬ ê¸ˆì§€
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                .body(ApiResponse.error(e.getErrorCode(), e.getMessage()));
    }
}
```

---

## Service ë ˆì´ì–´

| ì—ëŸ¬ ìœ í˜• | ì²˜ë¦¬ ë°©ì‹ | try/catch ì‚¬ìš© ì—¬ë¶€ | ì˜ˆì‹œ |
|-----------|-----------|---------------------|------|
| **ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¤‘ë‹¨ í•„ìš”** | `BusinessException` ë˜ì§€ê¸° (íŠ¸ëœì­ì…˜ ë¡¤ë°±) | âŒ ë°œìƒë§Œ, catch ì•ˆ í•¨ | ì¸ì¦ ì‹¤íŒ¨, ê¶Œí•œ ë¶€ì¡±, í•„ìˆ˜ ë°ì´í„° ëˆ„ë½ |
| **ì •ìƒ ë¶„ê¸° ì‹¤íŒ¨** | `Result<T>` ë˜ëŠ” `Optional<T>` ë°˜í™˜ | âœ… ì‚¬ìš© (ë‚´ë¶€ ì²˜ë¦¬) | ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ, ì¶”ì²œ ìŠ¤í‚µ |
| **ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨** | Retry/Circuit Breaker + ì˜ˆì™¸ ë³€í™˜ | âœ… ì‚¬ìš© (ë³µêµ¬ ì‹œë„) | AD ì¸ì¦ ì‹¤íŒ¨, SSO í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ |
| **ë°ì´í„°ë² ì´ìŠ¤ ì˜ˆì™¸** | JPA ì˜ˆì™¸ â†’ `BusinessException` ë³€í™˜ | âœ… ì‚¬ìš© (ì„ íƒì ) | `DataIntegrityViolationException` â†’ `DUPLICATE_KEY_ERROR` |
| **ë„ë©”ì¸ ê·œì¹™ ìœ„ë°˜** | `DomainException` ë°œìƒ â†’ Serviceì—ì„œ catch ë˜ëŠ” ì „íŒŒ | âœ… ì‚¬ìš© (ì„ íƒì ) | ìƒíƒœ ì „ì´ ë¶ˆê°€, ìŒìˆ˜ ê¸ˆì•¡ |

**ì›ì¹™:**
- âœ… ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¤‘ë‹¨ì´ í•„ìš”í•˜ë©´ `BusinessException` ë˜ì§€ê¸°
- âœ… ì‹¤íŒ¨ë„ ì •ìƒ íë¦„ì´ë©´ `Result<T>` ë°˜í™˜
- âœ… ì™¸ë¶€ ì‹œìŠ¤í…œ ì‹¤íŒ¨ëŠ” Retry + Fallback ê³ ë ¤
- âœ… íŠ¸ëœì­ì…˜ ë¡¤ë°± ì—¬ë¶€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ˆì™¸ vs Result ì„ íƒ

**Good Example (BusinessException):**
```java
@Transactional
public TokenResponse authenticate(LoginRequest request) {
    User user = userRepository.findByEmployeeId(request.getEmployeeId())
            .orElseThrow(() -> new BusinessException(ErrorCode.AUTH_001)); // âœ… ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¤‘ë‹¨
    
    if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
        throw new BusinessException(ErrorCode.AUTH_002); // âœ… íŠ¸ëœì­ì…˜ ë¡¤ë°± í•„ìš”
    }
    
    return jwtTokenProvider.generateToken(user);
}
```

**Good Example (Result<T>):**
```java
public Result<List<RecommendationDto>> getRecommendations(String userId) {
    try {
        List<Recommendation> recommendations = recommendationRepository.findByUserId(userId);
        
        if (recommendations.isEmpty()) {
            return Result.success(Collections.emptyList()); // âœ… ë¹ˆ ê²°ê³¼ë„ ì„±ê³µ
        }
        
        return Result.success(toDto(recommendations));
        
    } catch (Exception e) {
        log.error("Failed to get recommendations", e);
        return Result.failure("RECOMMENDATION_ERROR", "ì¶”ì²œ ì¡°íšŒ ì‹¤íŒ¨"); // âœ… ì‹¤íŒ¨ë„ ì •ìƒ ë¶„ê¸°
    }
}
```

---

## Domain ë ˆì´ì–´ (Entity, VO)

| ì—ëŸ¬ ìœ í˜• | ì²˜ë¦¬ ë°©ì‹ | try/catch ì‚¬ìš© ì—¬ë¶€ | ì˜ˆì‹œ |
|-----------|-----------|---------------------|------|
| **ë„ë©”ì¸ ë¶ˆë³€ì‹ ìœ„ë°˜** | `DomainException` ì¦‰ì‹œ ë°œìƒ | âŒ ë°œìƒë§Œ | ìŒìˆ˜ ê¸ˆì•¡, null í•„ìˆ˜ í•„ë“œ, ì˜ëª»ëœ ìƒíƒœ ì „ì´ |
| **ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨** | `DomainException` ì¦‰ì‹œ ë°œìƒ | âŒ ë°œìƒë§Œ | ìƒì„±ì íŒŒë¼ë¯¸í„° ê²€ì¦, setter ê·œì¹™ ê²€ì¦ |
| **ìƒíƒœ ì „ì´ ë¶ˆê°€** | `DomainException` ì¦‰ì‹œ ë°œìƒ | âŒ ë°œìƒë§Œ | `CLOSED` ì¼€ì´ìŠ¤ ì¬ì¢…ë£Œ ì‹œë„ |

**ì›ì¹™:**
- âœ… **í•­ìƒ ìœ íš¨í•œ ìƒíƒœë§Œ ìœ ì§€** (null/invalid ìƒíƒœ í—ˆìš© ì•ˆ í•¨)
- âœ… **ìƒì„±ì/Factory Methodì—ì„œ ìœ íš¨ì„± ê²€ì¦**
- âœ… **ìƒíƒœ ì „ì´ ë©”ì„œë“œì—ì„œ ê·œì¹™ ê²€ì¦**
- âŒ try-catch ì‚¬ìš© ê¸ˆì§€ (ì˜ˆì™¸ëŠ” Serviceë¡œ ì „íŒŒ)

**Good Example (Entity):**
```java
@Entity
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class DetectionCase {
    
    @Id
    private String caseId;
    
    @Enumerated(EnumType.STRING)
    private CaseStatus status;
    
    /**
     * Factory Method - ìœ íš¨ì„± ê²€ì¦ í¬í•¨
     */
    public static DetectionCase create(String caseId, CaseType type) {
        if (caseId == null || caseId.isBlank()) {
            throw new DomainException("ì¼€ì´ìŠ¤ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"); // âœ… ì¦‰ì‹œ ì˜ˆì™¸ ë°œìƒ
        }
        
        DetectionCase detectionCase = new DetectionCase();
        detectionCase.caseId = caseId;
        detectionCase.status = CaseStatus.OPEN;
        detectionCase.createdAt = LocalDateTime.now();
        
        return detectionCase;
    }
    
    /**
     * ìƒíƒœ ì „ì´ - ê·œì¹™ ê²€ì¦
     */
    public void close(String closureReason) {
        if (this.status == CaseStatus.CLOSED) {
            throw new DomainException("ì´ë¯¸ ì¢…ë£Œëœ ì¼€ì´ìŠ¤ì…ë‹ˆë‹¤"); // âœ… ìƒíƒœ ì „ì´ ë¶ˆê°€
        }
        
        if (closureReason == null || closureReason.isBlank()) {
            throw new DomainException("ì¢…ë£Œ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"); // âœ… í•„ìˆ˜ ì…ë ¥ ê²€ì¦
        }
        
        this.status = CaseStatus.CLOSED;
        this.closedAt = LocalDateTime.now();
    }
}
```

**Good Example (Value Object):**
```java
@Embeddable
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor(access = AccessLevel.PRIVATE)
public class Money {
    
    private BigDecimal amount;
    
    @Enumerated(EnumType.STRING)
    private Currency currency;
    
    /**
     * Factory Method - ìœ íš¨ì„± ê²€ì¦
     */
    public static Money of(BigDecimal amount, Currency currency) {
        if (amount == null || amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new DomainException("ê¸ˆì•¡ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤"); // âœ… ë„ë©”ì¸ ê·œì¹™ ê²€ì¦
        }
        
        if (currency == null) {
            throw new DomainException("í†µí™”ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
        }
        
        return new Money(amount, currency);
    }
    
    /**
     * ë¶ˆë³€ ì—°ì‚° - ìƒˆ ê°ì²´ ë°˜í™˜
     */
    public Money add(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new DomainException("í†µí™”ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"); // âœ… ì—°ì‚° ê·œì¹™ ê²€ì¦
        }
        
        return new Money(this.amount.add(other.amount), this.currency);
    }
}
```

---

## Repository ë ˆì´ì–´

| ì—ëŸ¬ ìœ í˜• | ì²˜ë¦¬ ë°©ì‹ | try/catch ì‚¬ìš© ì—¬ë¶€ | ì˜ˆì‹œ |
|-----------|-----------|---------------------|------|
| **JPA ì˜ˆì™¸** | Serviceë¡œ ì „íŒŒ (ë³€í™˜ ì—†ìŒ) | âŒ ì‚¬ìš© ê¸ˆì§€ | `DataIntegrityViolationException`, `OptimisticLockException` |
| **MyBatis ì˜ˆì™¸** | Serviceë¡œ ì „íŒŒ (ë³€í™˜ ì—†ìŒ) | âŒ ì‚¬ìš© ê¸ˆì§€ | `PersistenceException` |
| **DB ì—°ê²° ì‹¤íŒ¨** | Serviceë¡œ ì „íŒŒ | âŒ ì‚¬ìš© ê¸ˆì§€ | `CannotGetJdbcConnectionException` |

**ì›ì¹™:**
- âœ… RepositoryëŠ” **ì˜ì†í™” ë¡œì§ë§Œ ë‹´ë‹¹**
- âŒ ì˜ˆì™¸ ë³€í™˜ ê¸ˆì§€ (Springì´ ìë™ ë³€í™˜)
- âŒ try-catch ì‚¬ìš© ê¸ˆì§€
- âœ… Serviceì—ì„œ JPA ì˜ˆì™¸ë¥¼ BusinessExceptionìœ¼ë¡œ ë³€í™˜ (ì„ íƒì )

**Good Example (Repository):**
```java
@Mapper
public interface PolicyMapper {
    
    // âœ… JPA ì˜ˆì™¸ëŠ” Serviceë¡œ ìë™ ì „íŒŒ
    Optional<Policy> findById(@Param("id") String id);
    
    // âœ… MyBatis ì˜ˆì™¸ëŠ” Serviceë¡œ ìë™ ì „íŒŒ
    int insert(Policy policy);
    
    // âœ… ë‚™ê´€ì  ë½ ì˜ˆì™¸ë„ Serviceë¡œ ì „íŒŒ
    int update(Policy policy);
}
```

**Good Example (Serviceì—ì„œ JPA ì˜ˆì™¸ ì²˜ë¦¬):**
```java
@Service
@Transactional
public class PolicyService {
    
    private final PolicyMapper policyMapper;
    
    public void createPolicy(CreatePolicyRequest request) {
        Policy policy = Policy.from(request);
        
        try {
            policyMapper.insert(policy);
        } catch (DataIntegrityViolationException e) {
            // âœ… Serviceì—ì„œ JPA ì˜ˆì™¸ë¥¼ BusinessExceptionìœ¼ë¡œ ë³€í™˜
            throw new BusinessException("POLICY_DUPLICATE", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì •ì±…ì…ë‹ˆë‹¤");
        }
    }
}
```

---
