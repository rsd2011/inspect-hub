# ğŸ“ ë¡œê¹… ì „ëµ

> **ì›ì¹™**: ë””ë²„ê¹…ì— ìœ ìš©í•œ ì •ë³´ë¥¼ ë‚¨ê¸°ë˜, ì„±ëŠ¥ê³¼ ë³´ì•ˆì„ ê³ ë ¤

## 1. ë¡œê·¸ ë ˆë²¨ ì •ì˜

| ë ˆë²¨ | ìš©ë„ | ì˜ˆì‹œ | í”„ë¡œë•ì…˜ ì‚¬ìš© |
|------|------|------|---------------|
| **ERROR** | ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”í•œ ì—ëŸ¬ | DB ì—°ê²° ì‹¤íŒ¨, ì™¸ë¶€ API íƒ€ì„ì•„ì›ƒ | âœ… í•„ìˆ˜ |
| **WARN** | ì ì¬ì  ë¬¸ì œ, ë¹„ì •ìƒì  ìƒí™© | ì¸ì¦ ì‹¤íŒ¨, ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­ | âœ… ê¶Œì¥ |
| **INFO** | ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë²¤íŠ¸ | ë¡œê·¸ì¸ ì„±ê³µ, ì •ì±… ë°°í¬ | âœ… ê¶Œì¥ |
| **DEBUG** | ê°œë°œìë¥¼ ìœ„í•œ ìƒì„¸ ì •ë³´ | ë©”ì„œë“œ ì§„ì…/ì¢…ë£Œ, íŒŒë¼ë¯¸í„° ê°’ | âŒ ë¹„í™œì„±í™” |
| **TRACE** | ë§¤ìš° ìƒì„¸í•œ ë””ë²„ê¹… ì •ë³´ | SQL ì¿¼ë¦¬, ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· | âŒ ë¹„í™œì„±í™” |

## 2. êµ¬ì¡°í™”ëœ ë¡œê¹…

**ì›ì¹™:**
- âœ… í‚¤-ê°’ ìŒìœ¼ë¡œ ë¡œê·¸ ì‘ì„± (íŒŒì‹± ìš©ì´)
- âœ… ìƒê´€ê´€ê³„ ID (Trace ID) í¬í•¨
- âœ… JSON í˜•ì‹ ë¡œê¹… (í”„ë¡œë•ì…˜)

```java
@Service
@Slf4j
public class PolicyService {
    
    @Transactional
    public Policy createPolicy(CreatePolicyRequest request) {
        // âœ… Good: êµ¬ì¡°í™”ëœ ë¡œê¹…
        log.info("Creating policy: type={}, version={}, createdBy={}", 
                 request.getType(), 
                 request.getVersion(), 
                 getCurrentUserId());
        
        try {
            Policy policy = policyMapper.insert(request);
            
            // âœ… ì„±ê³µ ì‹œ ë¡œê·¸
            log.info("Policy created successfully: id={}, type={}", 
                     policy.getId(), 
                     policy.getType());
            
            return policy;
            
        } catch (DataIntegrityViolationException e) {
            // âŒ Bad: ë„ˆë¬´ ë§ì€ ì •ë³´
            // log.error("Error creating policy with request: {}", request, e);
            
            // âœ… Good: í•„ìˆ˜ ì •ë³´ë§Œ
            log.error("Failed to create policy: type={}, version={}, reason=DUPLICATE_KEY", 
                      request.getType(), 
                      request.getVersion());
            
            throw new BusinessException("POLICY_DUPLICATE", "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì •ì±…ì…ë‹ˆë‹¤");
        }
    }
}
```

## 3. MDC (Mapped Diagnostic Context) í™œìš©

**ëª©ì **: ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ìš”ì²­ ì¶”ì 

```java
@Component
public class RequestLoggingFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        
        // Trace ID ìƒì„±
        String traceId = UUID.randomUUID().toString();
        MDC.put("traceId", traceId);
        MDC.put("userId", getCurrentUserId());
        MDC.put("ipAddress", request.getRemoteAddr());
        
        try {
            filterChain.doFilter(request, response);
        } finally {
            // MDC ì •ë¦¬
            MDC.clear();
        }
    }
}
```

**logback.xml ì„¤ì •:**
```xml
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] [%X{traceId}] [%X{userId}] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeContext>true</includeContext>
            <includeMdc>true</includeMdc>
        </encoder>
    </appender>
</configuration>
```

## 4. ì˜ˆì™¸ ë¡œê¹… Best Practices

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        // âœ… WARN ë ˆë²¨ (ì˜ˆìƒëœ ì˜ˆì™¸)
        log.warn("Business exception: code={}, message={}, traceId={}", 
                 e.getErrorCode(), 
                 e.getMessage(), 
                 MDC.get("traceId"));
        
        return buildErrorResponse(e);
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleException(Exception e) {
        // âœ… ERROR ë ˆë²¨ (ì˜ˆìƒì¹˜ ëª»í•œ ì˜ˆì™¸)
        log.error("Unexpected exception: traceId={}, userId={}", 
                  MDC.get("traceId"), 
                  MDC.get("userId"), 
                  e); // âœ… ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ í¬í•¨
        
        return buildErrorResponse(ErrorCode.INTERNAL_ERROR);
    }
}
```

---
