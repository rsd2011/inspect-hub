# ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

> **ì›ì¹™**: ì‚¬ìš©ìì—ê²Œ ì‹œìŠ¤í…œ ë‚´ë¶€ ì •ë³´ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ì„œë„ ìœ ìš©í•œ ì—ëŸ¬ ì •ë³´ ì œê³µ

## 1. ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë…¸ì¶œ ë°©ì§€

**ë¬¸ì œì :**
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ë…¸ì¶œì€ **ë³´ì•ˆ ì·¨ì•½ì **
- ê³µê²©ìì—ê²Œ ì‹œìŠ¤í…œ êµ¬ì¡°, ì‚¬ìš© ê¸°ìˆ , ì½”ë“œ ê²½ë¡œ ì •ë³´ ì œê³µ

**í•´ê²°ë°©ë²•:**

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @Value("${spring.profiles.active:prod}")
    private String activeProfile;
    
    /**
     * ì˜ˆì¸¡í•˜ì§€ ëª»í•œ ì˜ˆì™¸ ì²˜ë¦¬
     * ê°œë°œ í™˜ê²½: ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ í¬í•¨
     * í”„ë¡œë•ì…˜: ì¼ë°˜ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ë§Œ ë°˜í™˜
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Object>> handleException(Exception e) {
        log.error("Unexpected exception occurred", e);
        
        // ê°œë°œ í™˜ê²½ì—ì„œë§Œ ìƒì„¸ ì •ë³´ ì œê³µ
        if ("local".equals(activeProfile) || "dev".equals(activeProfile)) {
            Map<String, Object> debugInfo = Map.of(
                "exception", e.getClass().getSimpleName(),
                "message", e.getMessage(),
                "stackTrace", Arrays.stream(e.getStackTrace())
                    .limit(10)
                    .map(StackTraceElement::toString)
                    .toList()
            );
            
            return ResponseEntity
                    .status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error("INTERNAL_ERROR", "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜", debugInfo));
        }
        
        // í”„ë¡œë•ì…˜: ì¼ë°˜ì ì¸ ë©”ì‹œì§€ë§Œ
        return ResponseEntity
                .status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(ApiResponse.error("INTERNAL_ERROR", "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"));
    }
}
```

## 2. ë¯¼ê° ì •ë³´ ë³´í˜¸

**ê¸ˆì§€ ì‚¬í•­:**
- âŒ ë¹„ë°€ë²ˆí˜¸, API í‚¤, í† í°ì„ ì˜ˆì™¸ ë©”ì‹œì§€ë‚˜ ë¡œê·¸ì— í¬í•¨
- âŒ ì‚¬ìš©ì ê°œì¸ì •ë³´ (ì£¼ë¯¼ë²ˆí˜¸, ê³„ì¢Œë²ˆí˜¸ ì „ì²´)ë¥¼ ë¡œê·¸ì— ê¸°ë¡
- âŒ SQL ì¿¼ë¦¬ ì „ì²´ë¥¼ ì˜ˆì™¸ ë©”ì‹œì§€ì— í¬í•¨
- âŒ ë‚´ë¶€ íŒŒì¼ ê²½ë¡œë¥¼ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œ

**Good Example:**
```java
@Service
public class AuthService {
    
    public TokenResponse authenticate(LoginRequest request) {
        User user = userRepository.findByEmployeeId(request.getEmployeeId())
                .orElseThrow(() -> new BusinessException(ErrorCode.AUTH_001));
        
        // âœ… ë¡œê·¸ì— ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹
        log.info("Login attempt: employeeId={}, ipAddress={}", 
                 request.getEmployeeId(), 
                 request.getIpAddress());
        
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            // âœ… ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¡œê·¸ì— ê¸°ë¡í•˜ì§€ ì•ŠìŒ
            log.warn("Invalid password for employeeId={}", request.getEmployeeId());
            throw new BusinessException(ErrorCode.AUTH_002);
        }
        
        return jwtTokenProvider.generateToken(user);
    }
}
```

**Bad Example:**
```java
// âŒ ë¯¼ê° ì •ë³´ ë…¸ì¶œ
log.error("Authentication failed: password={}, token={}", 
          request.getPassword(),  // âŒ ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ
          user.getAccessToken()); // âŒ í† í° ë…¸ì¶œ
```

## 3. SQL Injection ë°©ì§€

**ì›ì¹™:**
- âœ… MyBatisì˜ `#{}` íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì‚¬ìš© (Prepared Statement)
- âŒ `${}` ë¬¸ìì—´ ì¹˜í™˜ ì‚¬ìš© ê¸ˆì§€ (SQL Injection ì·¨ì•½)

```xml
<!-- âœ… Good: íŒŒë¼ë¯¸í„° ë°”ì¸ë”© -->
<select id="findByEmployeeId" resultType="User">
    SELECT * FROM users
    WHERE employee_id = #{employeeId}
</select>

<!-- âŒ Bad: ë¬¸ìì—´ ì¹˜í™˜ (SQL Injection ì·¨ì•½) -->
<select id="findByEmployeeId" resultType="User">
    SELECT * FROM users
    WHERE employee_id = '${employeeId}'
</select>
```

## 4. ì—ëŸ¬ ì½”ë“œ ê¸°ë°˜ ë³´ì•ˆ

**ì›ì¹™**: ê³µê²©ìì—ê²Œ ìœ ìš©í•œ ì •ë³´ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŒ

```java
// âœ… Good: ì¼ë°˜ì ì¸ ë©”ì‹œì§€
if (user == null || !passwordEncoder.matches(request.getPassword(), user.getPassword())) {
    throw new BusinessException(ErrorCode.AUTH_002); // "ì¸ì¦ ì‹¤íŒ¨"
}

// âŒ Bad: ê³µê²©ìì—ê²Œ ìœ ìš©í•œ ì •ë³´
if (user == null) {
    throw new BusinessException("USER_NOT_FOUND"); // âŒ ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ ë…¸ì¶œ
}
if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
    throw new BusinessException("INVALID_PASSWORD"); // âŒ ë¹„ë°€ë²ˆí˜¸ë§Œ í‹€ë ¸ìŒì„ ì•Œë ¤ì¤Œ
}
```

---
