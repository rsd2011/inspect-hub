# ğŸ”„ ì¬ì‹œë„/íšŒë¡œ ì°¨ë‹¨ íŒ¨í„´

## Spring Retry í™œìš©

**ì˜ì¡´ì„± ì¶”ê°€ (build.gradle):**
```gradle
implementation 'org.springframework.retry:spring-retry'
implementation 'org.springframework:spring-aspects'
```

**í™œì„±í™” (@EnableRetry):**
```java
@SpringBootApplication
@EnableRetry
public class InspectHubApplication {
    public static void main(String[] args) {
        SpringApplication.run(InspectHubApplication.class, args);
    }
}
```

**Serviceì—ì„œ Retry ì‚¬ìš©:**
```java
@Service
@RequiredArgsConstructor
public class ExternalApiService {
    
    private final RestTemplate restTemplate;
    
    /**
     * ì™¸ë¶€ API í˜¸ì¶œ with Retry
     * 
     * - ìµœëŒ€ 3íšŒ ì¬ì‹œë„
     * - 1ì´ˆ ê°„ê²©
     * - IOException, TimeoutExceptionë§Œ ì¬ì‹œë„
     */
    @Retryable(
        value = {IOException.class, TimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000)
    )
    public ExternalApiResponse callExternalApi(String endpoint) {
        try {
            return restTemplate.getForObject(endpoint, ExternalApiResponse.class);
        } catch (RestClientException e) {
            log.error("External API call failed: {}", endpoint, e);
            throw new BusinessException(ErrorCode.EXTERNAL_API_ERROR);
        }
    }
    
    /**
     * Retry ì‹¤íŒ¨ ì‹œ Fallback
     */
    @Recover
    public ExternalApiResponse recoverFromApiFailure(Exception e, String endpoint) {
        log.error("All retry attempts failed for: {}", endpoint, e);
        
        // Fallback: ê¸°ë³¸ ì‘ë‹µ ë°˜í™˜
        return ExternalApiResponse.empty();
    }
}
```

## Resilience4j Circuit Breaker í™œìš©

**ì˜ì¡´ì„± ì¶”ê°€:**
```gradle
implementation 'io.github.resilience4j:resilience4j-spring-boot3:2.1.0'
```

**ì„¤ì • (application.yml):**
```yaml
resilience4j:
  circuitbreaker:
    instances:
      ad-auth:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 60s
        permittedNumberOfCallsInHalfOpenState: 3
```

**Serviceì—ì„œ Circuit Breaker ì‚¬ìš©:**
```java
@Service
@RequiredArgsConstructor
public class AdAuthenticationService {
    
    private final LdapTemplate ldapTemplate;
    private final CircuitBreakerRegistry circuitBreakerRegistry;
    
    /**
     * AD ì¸ì¦ with Circuit Breaker
     */
    public TokenResponse authenticate(LoginRequest request) {
        CircuitBreaker circuitBreaker = circuitBreakerRegistry.circuitBreaker("ad-auth");
        
        try {
            return circuitBreaker.executeSupplier(() -> performAdAuthentication(request));
        } catch (CallNotPermittedException e) {
            // Circuitì´ Open ìƒíƒœ
            log.error("AD authentication circuit is OPEN");
            throw new BusinessException("AUTH_009", "AD ì„œë²„ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤");
        }
    }
    
    private TokenResponse performAdAuthentication(LoginRequest request) {
        try {
            ldapTemplate.authenticate(query()
                    .where("uid").is(request.getEmployeeId()),
                request.getPassword());
            
            return jwtTokenProvider.generateToken(request.getEmployeeId());
            
        } catch (Exception e) {
            log.error("AD authentication failed", e);
            throw new BusinessException(ErrorCode.AUTH_002);
        }
    }
}
```

---
