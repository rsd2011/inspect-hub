# ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

> **ì›ì¹™**: ì˜ˆì™¸ í•¸ë“¤ëŸ¬ë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì²˜ëŸ¼ í…ŒìŠ¤íŠ¸

## 1. MockMvcë¥¼ ì‚¬ìš©í•œ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ í…ŒìŠ¤íŠ¸

```java
@SpringBootTest
@AutoConfigureMockMvc
class GlobalExceptionHandlerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private AuthService authService;
    
    /**
     * BusinessException í…ŒìŠ¤íŠ¸
     */
    @Test
    @DisplayName("ì¸ì¦ ì‹¤íŒ¨ ì‹œ 401 ì‘ë‹µ ë°˜í™˜")
    void shouldReturn401WhenAuthenticationFails() throws Exception {
        // Given
        LoginRequest request = new LoginRequest("user001", "wrongPassword");
        when(authService.authenticate(any())).thenThrow(new BusinessException(ErrorCode.AUTH_002));
        
        // When & Then
        mockMvc.perform(post("/api/v1/auth/login")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
            .andExpect(status().isUnauthorized())
            .andExpect(jsonPath("$.success").value(false))
            .andExpect(jsonPath("$.errorCode").value("AUTH_002"))
            .andExpect(jsonPath("$.message").value("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"))
            .andDo(print());
    }
    
    /**
     * Validation ì˜ˆì™¸ í…ŒìŠ¤íŠ¸
     */
    @Test
    @DisplayName("ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­ ì‹œ 400 ì‘ë‹µ ë°˜í™˜")
    void shouldReturn400WhenValidationFails() throws Exception {
        // Given
        LoginRequest invalidRequest = new LoginRequest("", ""); // ë¹ˆ ê°’
        
        // When & Then
        mockMvc.perform(post("/api/v1/auth/login")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(invalidRequest)))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.errorCode").value("VALIDATION_ERROR"))
            .andDo(print());
    }
    
    /**
     * ì˜ˆì¸¡í•˜ì§€ ëª»í•œ ì˜ˆì™¸ í…ŒìŠ¤íŠ¸
     */
    @Test
    @DisplayName("ì˜ˆì¸¡í•˜ì§€ ëª»í•œ ì˜ˆì™¸ ì‹œ 500 ì‘ë‹µ ë°˜í™˜")
    void shouldReturn500WhenUnexpectedExceptionOccurs() throws Exception {
        // Given
        when(authService.authenticate(any())).thenThrow(new RuntimeException("Database connection lost"));
        
        // When & Then
        mockMvc.perform(post("/api/v1/auth/login")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(new LoginRequest("user001", "password"))))
            .andExpect(status().isInternalServerError())
            .andExpect(jsonPath("$.errorCode").value("INTERNAL_ERROR"))
            .andDo(print());
    }
}
```

## 2. Service ë ˆì´ì–´ ì˜ˆì™¸ í…ŒìŠ¤íŠ¸

```java
@ExtendWith(MockitoExtension.class)
class AuthServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @InjectMocks
    private AuthService authService;
    
    @Test
    @DisplayName("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ AUTH_001 ì˜ˆì™¸ ë°œìƒ")
    void shouldThrowAuth001WhenUserNotFound() {
        // Given
        LoginRequest request = new LoginRequest("nonexistent", "password");
        when(userRepository.findByEmployeeId("nonexistent")).thenReturn(Optional.empty());
        
        // When & Then
        BusinessException exception = assertThrows(BusinessException.class, 
            () -> authService.authenticate(request));
        
        assertThat(exception.getErrorCode()).isEqualTo("AUTH_001");
        assertThat(exception.getMessage()).contains("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
    }
    
    @Test
    @DisplayName("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ ì‹œ AUTH_002 ì˜ˆì™¸ ë°œìƒ")
    void shouldThrowAuth002WhenPasswordMismatch() {
        // Given
        User user = User.builder()
            .employeeId("user001")
            .password("encodedPassword")
            .build();
        
        LoginRequest request = new LoginRequest("user001", "wrongPassword");
        when(userRepository.findByEmployeeId("user001")).thenReturn(Optional.of(user));
        when(passwordEncoder.matches("wrongPassword", "encodedPassword")).thenReturn(false);
        
        // When & Then
        BusinessException exception = assertThrows(BusinessException.class, 
            () -> authService.authenticate(request));
        
        assertThat(exception.getErrorCode()).isEqualTo("AUTH_002");
    }
}
```

## 3. ë„ë©”ì¸ ì˜ˆì™¸ í…ŒìŠ¤íŠ¸

```java
class DetectionCaseTest {
    
    @Test
    @DisplayName("ìœ íš¨í•˜ì§€ ì•Šì€ ì¼€ì´ìŠ¤ IDë¡œ ìƒì„± ì‹œ DomainException ë°œìƒ")
    void shouldThrowDomainExceptionWhenCaseIdIsNull() {
        // When & Then
        assertThatThrownBy(() -> DetectionCase.create(null, CaseType.STR))
            .isInstanceOf(DomainException.class)
            .hasMessageContaining("ì¼€ì´ìŠ¤ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤");
    }
    
    @Test
    @DisplayName("ì´ë¯¸ ì¢…ë£Œëœ ì¼€ì´ìŠ¤ ì¢…ë£Œ ì‹œ DomainException ë°œìƒ")
    void shouldThrowDomainExceptionWhenClosingClosedCase() {
        // Given
        DetectionCase detectionCase = DetectionCase.create("CASE001", CaseType.STR);
        detectionCase.close("Resolved");
        
        // When & Then
        assertThatThrownBy(() -> detectionCase.close("Duplicate close"))
            .isInstanceOf(DomainException.class)
            .hasMessageContaining("ì´ë¯¸ ì¢…ë£Œëœ ì¼€ì´ìŠ¤ì…ë‹ˆë‹¤");
    }
}
```

---
