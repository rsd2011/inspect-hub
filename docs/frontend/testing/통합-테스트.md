# 통합 테스트

## API 통합 테스트

```typescript
// shared/api/client.test.ts
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest'
import { setupServer } from 'msw/node'
import { http, HttpResponse } from 'msw'
import { createApiClient } from './client'

const server = setupServer()

beforeEach(() => server.listen({ onUnhandledRequest: 'error' }))
afterEach(() => server.resetHandlers())
afterAll(() => server.close())

describe('ApiClient', () => {
  const apiClient = createApiClient({
    baseURL: 'http://localhost:8090/api/v1'
  })
  
  it('GET 요청 성공', async () => {
    server.use(
      http.get('http://localhost:8090/api/v1/users/123', () => {
        return HttpResponse.json({
          success: true,
          data: {
            id: '123',
            username: 'testuser',
            email: 'test@example.com'
          }
        })
      })
    )
    
    const response = await apiClient.get('/users/123')
    
    expect(response.success).toBe(true)
    expect(response.data.username).toBe('testuser')
  })
  
  it('POST 요청 성공', async () => {
    server.use(
      http.post('http://localhost:8090/api/v1/users', async ({ request }) => {
        const body = await request.json()
        return HttpResponse.json({
          success: true,
          data: {
            id: '456',
            ...body
          }
        }, { status: 201 })
      })
    )
    
    const newUser = {
      username: 'newuser',
      email: 'new@example.com'
    }
    
    const response = await apiClient.post('/users', newUser)
    
    expect(response.success).toBe(true)
    expect(response.data.username).toBe('newuser')
  })
  
  it('401 에러 시 토큰 갱신 후 재시도', async () => {
    let requestCount = 0
    
    server.use(
      http.get('http://localhost:8090/api/v1/protected', () => {
        requestCount++
        if (requestCount === 1) {
          return HttpResponse.json(
            { success: false, error: { code: 'UNAUTHORIZED' } },
            { status: 401 }
          )
        }
        return HttpResponse.json({ success: true, data: 'protected data' })
      }),
      http.post('http://localhost:8090/api/v1/auth/refresh', () => {
        return HttpResponse.json({
          success: true,
          data: { accessToken: 'new-token' }
        })
      })
    )
    
    const response = await apiClient.get('/protected')
    
    expect(requestCount).toBe(2)  // 초기 요청 + 재시도
    expect(response.success).toBe(true)
  })
  
  it('네트워크 에러 처리', async () => {
    server.use(
      http.get('http://localhost:8090/api/v1/data', () => {
        return HttpResponse.error()
      })
    )
    
    await expect(apiClient.get('/data')).rejects.toThrow()
  })
  
  it('요청 헤더에 인증 토큰 포함', async () => {
    let capturedHeaders: Headers | undefined
    
    server.use(
      http.get('http://localhost:8090/api/v1/data', ({ request }) => {
        capturedHeaders = request.headers
        return HttpResponse.json({ success: true, data: {} })
      })
    )
    
    apiClient.setToken('test-token')
    await apiClient.get('/data')
    
    expect(capturedHeaders?.get('Authorization')).toBe('Bearer test-token')
  })
})
```

---
